<!DOCTYPE html>
<html>
<head>
    <title>Web3 Social</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>
    <div id="app">
        <h1>Web3 Marketplace</h1>
        <div v-if="!walletAddress">
            <button @click="connectWallet">Connect MetaMask</button>
        </div>
        <div v-else>
            <p>Connected: <strong>{{ walletAddress }}</strong></p>
            <input v-model="msgInput" placeholder="Message...">
            <button @click="submit">Post</button>
        </div>
        <hr>
        <ul>
            <li v-for="msg in messages">
                <strong>{{ msg.wallet }}</strong>: {{ msg.text }}
            </li>
        </ul>
    </div>

    <script>
        const firebaseConfig = { projectId: "web3-social-connect" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        new Vue({
            el: "#app",
            data: {
                walletAddress: "",
                msgInput: "",
                messages: []
            },
            methods: {
                async connectWallet() {
                    if (window.ethereum) {
                        try {
                            const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
                            this.walletAddress = accounts[0];
                        } catch (err) {
                            console.error("Wallet connection failed", err);
                        }
                    } else {
                        alert("Please install MetaMask");
                    }
                },
                submit() {
                    if (!this.msgInput) return;
                    db.collection("messages").add({
                        text: this.msgInput,
                        wallet: this.walletAddress,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    this.msgInput = "";
                }
            },
            mounted() {
                // This makes the messages appear in real-time
                db.collection("messages").orderBy("createdAt", "desc").onSnapshot(snapshot => {
                    this.messages = snapshot.docs.map(doc => doc.data());
                });
            }
        });
    </script>
</body>
</html>
